<div class="flex flex-col space-y-10">
    <div class="bg-gradient-to-r from-indigo-600 to-blue-500 rounded-3xl p-10 text-white shadow-2xl">
        <h1 class="text-4xl font-bold mb-4">LeChung Tech</h1>
        <p class="text-indigo-100 text-lg max-w-xl">Tr·∫£i nghi·ªám c√¥ng ngh·ªá ƒë·ªânh cao v·ªõi c√°c d√≤ng s·∫£n ph·∫©m m·ªõi nh·∫•t, gi√° c·∫£ ∆∞u ƒë√£i v√† d·ªãch v·ª• b·∫£o h√†nh chuy√™n nghi·ªáp.</p>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-wrap gap-4 items-center">
        <form id="search-form" action="/products/search" method="GET" class="flex-1 flex gap-2">
            <input type="hidden" name="page" value="1"> 
            
            <input type="text" id="keyword-input" name="keyword" 
                   value="<%= typeof keyword !== 'undefined' ? keyword : '' %>" 
                   placeholder="T√¨m t√™n s·∫£n ph·∫©m..." 
                   class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500 transition">
            
            <select id="category-select" name="categoryId" 
                    class="bg-slate-50 border-none rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500 transition text-slate-600 font-medium">
                <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                <% categories.forEach(cat => { %>
                    <option value="<%= cat.categoryId %>" <%= (typeof categoryId !== 'undefined' && categoryId === cat.categoryId) ? 'selected' : '' %>>
                        <%= cat.name %>
                    </option>
                <% }) %>
            </select>

            <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700 transition font-bold shadow-lg shadow-indigo-100">
                L·ªçc
            </button>
        </form>

        <% if (user && user.role === 'admin') { %>
            <div class="flex gap-2">
                <a href="/products/logs" class="bg-slate-800 text-white px-6 py-2 rounded-xl hover:bg-slate-900 font-bold transition shadow-lg shadow-slate-200">
                    üìã Xem l·ªãch s·ª≠
                </a>
                <a href="/products/add" class="bg-emerald-500 text-white px-6 py-2 rounded-xl hover:bg-emerald-600 font-bold transition shadow-lg shadow-emerald-100">
                    + Nh·∫≠p h√†ng
                </a>
            </div>
        <% } %>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
        <% if (products.length > 0) { %>
            <% products.forEach(p => { %>
                <div class="group bg-white rounded-3xl border border-slate-100 overflow-hidden hover:shadow-2xl hover:-translate-y-2 transition duration-300 relative">
                    <div class="absolute top-4 left-4 z-10">
                        <span class="px-3 py-1 text-[10px] font-bold uppercase rounded-full shadow-md 
                            <%= p.quantity <= 0 ? 'bg-red-500 text-white' : (p.quantity < 5 ? 'bg-orange-500 text-white' : 'bg-emerald-500 text-white') %>">
                            <%= p.quantity <= 0 ? 'H·∫øt h√†ng' : (p.quantity < 5 ? 'S·∫Øp h·∫øt' : 'S·∫µn h√†ng') %>
                        </span>
                    </div>

                    <div class="aspect-square bg-slate-50 overflow-hidden">
                        <img src="<%= p.url_image || 'https://via.placeholder.com/400' %>" 
                             alt="<%= p.name %>" loading="lazy"
                             class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                    </div>

                    <div class="p-6">
                        <p class="text-xs text-slate-400 font-semibold mb-1 uppercase tracking-widest"><%= p.categoryName %></p>
                        <h3 class="text-lg font-bold text-slate-800 mb-2 truncate" title="<%= p.name %>"><%= p.name %></h3>
                        <p class="text-2xl font-black text-indigo-600 mb-4">
                            <%= p.price.toLocaleString() %> <span class="text-sm font-normal text-slate-400">ƒë</span>
                        </p>
                        
                        <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                            <span class="text-sm text-slate-500 font-medium italic">Kho: <%= p.quantity %></span>
                            <div class="flex space-x-1">
                                <% if (user && user.role === 'admin') { %>
                                    <a href="/products/edit/<%= p.id %>" 
                                       class="px-3 py-1.5 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition">
                                        S·ª≠a
                                    </a>
                                    <form action="/products/delete" method="POST" class="inline">
                                        <input type="hidden" name="id" value="<%= p.id %>">
                                        <button type="submit" 
                                                class="px-3 py-1.5 text-xs font-bold text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition" 
                                                onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?')">
                                            X√≥a
                                        </button>
                                    </form>
                                <% } else { %>
                                    <form action="/products/buy-now" method="POST" class="inline">
                                        <input type="hidden" name="productId" value="<%= p.id %>">
                                        <button type="submit" 
                                                class="px-4 py-1.5 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition"
                                                <%= p.quantity <= 0 ? 'disabled' : '' %>>
                                            Mua ngay
                                        </button>
                                    </form>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="col-span-full py-20 text-center">
                <p class="text-slate-400 text-lg">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o kh·ªõp v·ªõi y√™u c·∫ßu.</p>
            </div>
        <% } %>
    </div>

    <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
        <div class="flex justify-center items-center space-x-2 mt-12 pb-10">
            <% if (currentPage > 1) { %>
                <a href="?page=<%= currentPage - 1 %>&keyword=<%= keyword %>&categoryId=<%= categoryId %>" 
                   class="p-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
            <% } %>

            <div class="flex items-center bg-white border border-slate-200 rounded-2xl p-1 shadow-sm">
                <% for(let i = 1; i <= totalPages; i++) { %>
                    <a href="?page=<%= i %>&keyword=<%= keyword %>&categoryId=<%= categoryId %>" 
                       class="px-4 py-2 rounded-xl text-sm font-bold transition <%= i === currentPage ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50' %>">
                        <%= i %>
                    </a>
                <% } %>
            </div>

            <% if (currentPage < totalPages) { %>
                <a href="?page=<%= currentPage + 1 %>&keyword=<%= keyword %>&categoryId=<%= categoryId %>" 
                   class="p-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
            <% } %>
        </div>
    <% } %>
</div>

<script>
    const searchForm = document.getElementById('search-form');
    const keywordInput = document.getElementById('keyword-input');
    const categorySelect = document.getElementById('category-select');
    let typingTimer;

    keywordInput.addEventListener('input', () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            searchForm.querySelector('input[name="page"]').value = 1;
            searchForm.submit();
        }, 500);
    });

    categorySelect.addEventListener('change', () => {
        searchForm.querySelector('input[name="page"]').value = 1;
        searchForm.submit();
    });

    const val = keywordInput.value;
    if (val) {
        keywordInput.focus();
        keywordInput.setSelectionRange(val.length, val.length);
    }
</script>